#!/usr/bin/env sh
set -eu

echo "husky(pre-push): test"
npm run test

if ! git rev-parse --verify HEAD >/dev/null 2>&1; then
  exit 0
fi

if git rev-parse --abbrev-ref --symbolic-full-name @{upstream} >/dev/null 2>&1; then
  range="@{upstream}..HEAD"
elif git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
  range="HEAD~1..HEAD"
else
  range="HEAD"
fi

for sha in $(git rev-list "$range"); do
  if ! git show -s --format=%B "$sha" | grep -qi '^Signed-off-by:'; then
    echo "Push blocked: commit $sha is missing a Signed-off-by trailer."
    echo "Use: git commit --amend -s"
    exit 1
  fi
done
